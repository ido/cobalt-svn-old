#!/bin/sh
#
# Cobalt
#
# chkconfig: 2345 18 09
# description: Cobalt resource manager/scheduler
#

prefix=@prefix@
exec_prefix=@exec_prefix@
CONFIGPATH=@sysconfdir@
CONFIGFILE="${CONFIGPATH}/cobalt.conf"
DAEMONDIR=@sbindir@
PIDPATH=@PATH_TO_PIDFILE@

start_component () {
    component=$1
    echo -n "Starting ${component}: "
    "${DAEMONDIR}/${component}.py" -C "${CONFIGFILE}" -D "${PIDPATH}/${component}.pid"
    echo "done"
    return 0
}

stop_component () {
    component=$1
    if [ -f "${PIDPATH}/${component}.pid" ] ; then
	echo -n "Stopping ${component}: "
	kill -INT `cat ${PIDPATH}/${component}.pid`
	echo "done"
	rm -f "${PIDPATH}/${component}.pid"
    else
	echo "${component} not running"
    fi
    return 0
}

# Configure DB2 environment
. /discovery/db.src

case "$1" in
  start)
    for component in slp bgpm cqm bgsched; do
	start_component $component
    done
    touch /var/lock/subsys/cobalt
    ;;
  start-debug)
    "${DAEMONDIR}/slp.py" -C "${CONFIGFILE}" -D "${PIDPATH}/slp.pid"
    "${DAEMONDIR}/bgpm.py" --notbgl -C "${CONFIGFILE}" -D "${PIDPATH}/bgpm.pid"
    "${DAEMONDIR}/cqm.py" -C "${CONFIGFILE}" -D "${PIDPATH}/cqm.pid"
    "${DAEMONDIR}/bgsched.py" --nodb2 -C "${CONFIGFILE}" -D "${PIDPATH}/bgsched.pid"
    touch /var/lock/subsys/cobalt
    ;;
  stop)
    for component in bgsched cqm bgpm slp; do
	stop_component $component
    done
    rm -f /var/lock/subsys/cobalt
    ;;
  restart)
    if [ $# -gt 1 ] ; then
	shift
	for component in $@; do 
	    case "$component" in 
		cqm|bgsched)
		    stop_component $component
		    start_component $component
		    ;;
		slp|bgpm)
		    echo "${component} cannot be restarted with jobs running"
		    ;;
	    esac
	done
    else
	$0 stop
	$0 start
    fi
    ;;
  force-reload)
    $0 stop
    $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|force-reload}"
    exit 1
esac

exit 0



